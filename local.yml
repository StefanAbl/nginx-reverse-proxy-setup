---
- hosts: all
  vars_files:
    - /root/vars.yaml
  tasks:
  - name: install basic packages
    action: >
      {{ ansible_pkg_mgr }} name={{ item }} state=present update_cache=yes
    with_items:
      - git
      - nginx

  - name: check if git repo present
    stat:
      path: /root/acme.sh/dnsapi/dns_dynv6.sh
    register: acme_present

  - name: get git repo
    git:
     repo: https://github.com/Neilpang/acme.sh.git
     dest: /root/acme.sh
    when: acme_present.stat.exists == false
  - name: get pull request
    command: 
      cmd: git fetch origin pull/2470/head
      chdir: /root/acme.sh
    when: acme_present.stat.exists == false
  - name: get pull request2
    command: 
      cmd: git checkout -b pullrequest FETCH_HEAD
      chdir: /root/acme.sh
    when: acme_present.stat.exists == false

  - name: add A record
    command:
      cmd: ssh api@dynv6.com -i /root/.ssh/dynv6 hosts {{ host }} records set {{ record }} a addr {{ ip }}

  - name: create cert dir
    file:
      path: /etc/letsencrypt/live/{{record}}.{{host}}/
      state: directory
      owner: www-data
      group: www-data
      mode: 0770
  
  - name: check if cert present
    stat:
      path: /etc/letsencrypt/live/{{record}}.{{host}}/fullchain.pem
    register: cert_present
  - name: check if cert needs to be renewd
    openssl_certificate_info:
      path: /etc/ssl/crt/ansible.com.crt
      valid_at: "+d25"
    register: cert_valid
    when: cert_present.stat.exists == true


  - name: get cert REMOVE STAGING
    command: /root/acme.sh/acme.sh --issue --staging --dns dns_dynv6 -d {{record}}.{{host}}  --key-file /etc/letsencrypt/live/{{record}}.{{host}}/key.pem --ca-file /etc/letsencrypt/live/{{record}}.{{host}}/ca.pem --cert-file /etc/letsencrypt/live/{{record}}.{{host}}/cert.pem --fullchain-file /etc/letsencrypt/live/{{record}}.{{host}}/fullchain.pem
    environment:
      KEY: "{{key_file}}"
    when: (cert-valid.valid_at == false) or (cert_present.stat.exists == false)

  - name: copy nginx config template
    template:
      src: proxy.conf
      dest: /etc/nginx/sites-available/{{record}}.{{host}}
      owner: www-data
      group: www-data
      mode: '0664'

  - name: add cronjob for certificates
    cron:
      name: "cert for {{record}}.{{host}}"
      day: "*/15"
      user: root
      job: /root/acme.sh/acme.sh --issue --staging --dns dns_dynv6 -d {{record}}.{{host}}  --key-file /etc/letsencrypt/live/{{record}}.{{host}}/key.pem --ca-file /etc/letsencrypt/live/{{record}}.{{host}}/ca.pem --cert-file /etc/letsencrypt/live/{{record}}.{{host}}/cert.pem --fullchain-file /etc/letsencrypt/live/{{record}}.{{host}}/fullchain.pem

  - name: restart nginx
    service: 
      name: nginx 
      state: restarted